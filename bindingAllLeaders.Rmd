---
title: "Binding 18,19 and 20 Leaders"
author: "Dave Lovell"
date: "01/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Libraries
```{r libraries, message = FALSE, warning = FALSE}
library("here")
library("dplyr")
library("forcats")
library("magrittr")
library("carutools") # used for postcodes. Get it w/ "devtools::install_github("davelovellCARU/carutools")
library("stringr")
library("lubridate")
library("readr")
```

## Load the Data

If the Data's not there, you might do well to run `2020LeadersCleaning.Rmd`. That _should_ get the data if you're connected to `O:/` if you're not connected to `O:/` that's too bad.

```{r loadTheData}
newLeaders <- readRDS(here::here("data/leaders2020Data.rdat"))
oldLeaders <- readRDS(here::here("data/leadersResponses2018and2019.rdat"))
```

## Examine column names

What's in one but not the other?

```{r examineColNames}
### Things in old but not in new
names(oldLeaders) %>% {.[!(. %in% names(newLeaders))]}
names(newLeaders) %>% {.[!(. %in% names(oldLeaders))]}
```

## Sorting out columns

### Generate Empty Columns

Some things just need to be added as `NA`:

```{r emptyGenerate}
### New Leaders
newLeaders[["info_deanery"]] <- NA

### Old Leaders
oldLeaders[["sm_responseId"]] <- NA
oldLeaders[["consent_name"]] <- NA
oldLeaders[["consent_date"]] <- NA


```

### Rename Columns

Some things just need renaming

```{r renameCols}
oldLeaders %<>% 
  rename("info_day_1" = "info_days", # There's only 1 day in 'days'
         "info_startTime_1" = "info_startTime",
         "info_endTime_1" = "info_endTime")
```

### Mutate Columns

Some things in old could use a `mutate()` into several columns

```{r mutateCools}
### Pulling Out Address from Old
oldLeaders %<>%
  mutate(info_venuePostcode = 
           info_venueDetails %>% 
           (carutools::ct_extract_postcode), 
         info_venueWebsite =
           info_venueDetails %>% 
           str_extract("[^[:space:]]*(\\.org|\\.uk|\\.com)[^[:space:]]*") %>% 
           str_remove_all("[:punct:]+(?=$)"),
         info_venueAddress = 
           info_venueDetails %>% ## Not this method leaves some postcodes in 'address', because they're not real postcodes. Probably fixable if you experiment with 0/O, but bun that amirite?
           str_remove(ct_postcode_regex(anchors = FALSE)) %>% # remove postcodes
           str_remove("[^[:space:]]*(\\.org|\\.uk|\\.com)[^[:space:]]*") %>% # remove website
           str_remove("[[:space:][:punct:]]+(?=$)")) # trim whitespace / trailing commas etc.
### Drop venueDetails
oldLeaders %<>% select(-info_venueDetails)

### Format the start and end times to be consistent
### newLeaders is parsed using a readr function invoked by read_csv
oldLeaders %<>%
  mutate(across(all_of(c("info_startTime_1", "info_endTime_1")),
           ~ as.character(.) %>%
           str_extract("\\d\\d:\\d\\d:\\d\\d") %>%
           parse_time()))
```